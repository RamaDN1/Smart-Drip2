<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valve & Time</title>
  <link rel="stylesheet" href="valve.css" />
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>
<body>
  <main class="main-content">
    <header>
      <div class="top-controls">
  <div class="toggle-menu-btn" id="menuButton" onclick="toggleMenu()">
    <span></span><span></span><span></span>
  </div>
  <div id="notificationToggle" class="notification-tab" onclick="toggleNotificationPanel()">
    <span style="font-size: 22px;">ğŸ””</span>
    <span>Notifications</span>
    <span id="notifBadge" class="notif-badge hidden">â—</span>
  </div>
  <div id="userGreeting" style="margin-right: 20px; font-weight: bold; color: #9147d5;"></div>
</div>
      </div>
      <div class="sidebar-menu" id="sideMenu">
        <a href="home.html">Home</a>
        <a href="creat_entry.html">Creat_Entry</a>
        <a href="room.html">Rooms</a>
        <a class="active" href="valve&time.html">Valve & Time</a>
        <a href="Features.html">Features</a>
        <a href="reviwe.html">Review</a>
        <a href="help.html">Help</a>
        <a href="#" id="logoutBtn">Logout</a>
      </div>
    </header>

    <div class="dashboard-container">
      <div id="notificationsPanel" class="notifications-panel hidden">
        <h2>ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <ul id="notificationsList"></ul>
        <button onclick="clearNotifications()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <br><br>
      <div class="container">
        <h1>Smart Valve Control</h1>
        <div class="time-control">
          <div class="time-input">
            <label for="roomSelect">Select Room:</label>
            <select id="roomSelect" required>
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØºØ±ÙØ© --</option>
            </select>
          </div>
          <div class="time-input">
            <label for="startTime">Start Time (HH:MM):</label>
            <input type="time" id="startTime" required />
          </div>
          <div class="time-input">
            <label for="endTime">End Time (HH:MM):</label>
            <input type="time" id="endTime" required />
          </div>
          <button id="setTime" class="time-btn">Set Time</button>
        </div>

        <h1>Valve Control</h1>
        <div class="valve-control">
          <button id="openValve" class="valve-btn open-btn">Open Valve ğŸ”“</button>
          <button id="closeValve" class="valve-btn close-btn">Close Valve ğŸ”’</button>
        </div>

        <div class="status-container">
          <p class="status" id="valveStatus">Status: Waiting for action</p>
        </div>

        <h2>Room Valve Status</h2>
        <div id="roomStatusContainer" class="room-status"></div>
      </div>

      <audio id="notifSound" src="sounds/ding.mp3" preload="auto"></audio>
    </div>
  </main>

  <script>
    let userRole = null;
    const token = localStorage.getItem("authToken");
    const userData = localStorage.getItem("user");

    if (!token || !userData) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      window.location.href = "/login.html";
    }

    const user = JSON.parse(userData);
    userRole = user.role;
    document.getElementById("userGreeting").textContent = `ğŸ‘¤ ${user.name} (${user.role})`;

    document.addEventListener("DOMContentLoaded", function () {
      if (!['admin', 'doctor', 'nurse'].includes(userRole)) {
        document.getElementById("openValve").style.display = "none";
        document.getElementById("closeValve").style.display = "none";
        document.getElementById("setTime").style.display = "none";
      }

      loadRooms();
      loadAllValveStatuses();
      renderNotifications();

      document.getElementById("openValve").addEventListener("click", () => toggleValve("open"));
      document.getElementById("closeValve").addEventListener("click", () => toggleValve("closed"));
      document.getElementById("setTime").addEventListener("click", setSchedule);
      document.getElementById("roomSelect").addEventListener("change", fetchValveStatus);
    });

    async function loadRooms() {
      try {
        const res = await fetch("/api/rooms", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const select = document.getElementById("roomSelect");
        data.rooms.forEach(room => {
          const opt = document.createElement("option");
          opt.value = room.id;
          opt.textContent = `Room ${room.room_number}`;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error("loadRooms error:", e);
      }
    }

    async function loadAllValveStatuses() {
      try {
        const res = await fetch("/api/valve_status", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const container = document.getElementById("roomStatusContainer");
        container.innerHTML = "";
        data.forEach(status => {
          const box = document.createElement("div");
          box.className = `room-box room-${status.status}`;
          box.textContent = `Room ${status.room_id}: ${status.status}`;
          container.appendChild(box);
        });
      } catch (e) {
        console.error("loadAllValveStatuses error:", e);
      }
    }

    async function fetchValveStatus() {
      const roomId = document.getElementById("roomSelect").value;
      if (!roomId) return;
      try {
        const res = await fetch(`/api/valve_status/${roomId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        updateStatusUI(data.status);
      } catch (e) {
        console.error("fetchValveStatus error:", e);
      }
    }

    async function toggleValve(action) {
      const roomId = document.getElementById("roomSelect").value;
      if (!roomId) return alert("Please select a room first");
      try {
        const res = await fetch(`/api/valve_status/${roomId}`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ status: action })
        });
        const data = await res.json();
        updateStatusUI(data.valve_status.status);
        addNotification(`Valve ${action}ed for Room ${roomId}`);
      } catch (e) {
        console.error("toggleValve error:", e);
      }
    }

    function updateStatusUI(status) {
      const statusText = document.getElementById("valveStatus");
      statusText.textContent = `Status: Valve is ${status}`;
      statusText.className = `status ${status}`;
      loadAllValveStatuses();
    }

    async function setSchedule() {
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;
      if (!start || !end) return alert("Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©");
      try {
        const res = await fetch("/api/valve_status/schedule", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ start, end })
        });
        if (!res.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©");
        alert("ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­");
        addNotification(`ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© Ù…Ù† ${start} Ø¥Ù„Ù‰ ${end}`);
      } catch (e) {
        console.error("setSchedule error:", e);
      }
    }

    function addNotification(msg) {
      const list = document.getElementById("notificationsList");
      const item = document.createElement("li");
      item.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      list.appendChild(item);
      playNotificationSound();
      document.getElementById("notifBadge").classList.remove("hidden");
    }

    function playNotificationSound() {
      const sound = document.getElementById("notifSound");
      sound.currentTime = 0;
      sound.play();
    }

    function clearNotifications() {
      document.getElementById("notificationsList").innerHTML = "";
    }

    function toggleNotificationPanel() {
      const panel = document.getElementById("notificationsPanel");
      panel.classList.toggle("hidden");
      if (!panel.classList.contains("hidden")) {
        document.getElementById("notifBadge").classList.add("hidden");
      }
    }

    function toggleMenu() {
      document.getElementById("sideMenu").classList.toggle("open");
      document.getElementById("menuButton").classList.toggle("open");
    }
  </script>
</body>
</html>
