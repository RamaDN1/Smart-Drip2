<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>medical_report</title>
  <link rel="stylesheet" href="medical_report.css"/>
</head>
<body>
  <header>
    <img src="images/logo.jpeg" width="150">
  </header><br><br><br><br>

  <!-- Ø§Ù„ØºØ·Ø§Ø¡ -->
  <div class="menu-overlay" id="overlay" onclick="closeMenu()"></div>

  <div class="container">
    <a class="back-btn" href="creat_entry.html"><i class='bx bx-arrow-back'></i> Back to Page</a>
    <h2>ğŸ“‹ Patient's medical report</h2>
    <table id="reviewHistoryTable">
      <thead>
        <tr>
          <th>ğŸ“… Date</th>
          <th>â° Time</th>
          <th>ğŸ“ Doctor's Notes</th>
          <th>ğŸ¥ Reason for Admission</th>
          <th>ğŸ”„ Update Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 12 Ø³Ø§Ø¹Ø© Ù…Ø¹ AM/PM
    function formatTime(time) {
      const [hour, minute] = time.split(":");
      let hour12 = parseInt(hour, 10);
      const ampm = hour12 >= 12 ? 'Ù…' : 'Øµ';
      hour12 = hour12 % 12;
      if (hour12 === 0) hour12 = 12;
      return `${hour12}:${minute} ${ampm}`;
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(date) {
      return new Date(date).toLocaleDateString('ar-SA', { calendar: 'gregory' });
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('id');

    if (patientId) {
      loadReviewHistory(patientId);
    } else {
      document.querySelector("#reviewHistoryTable tbody").innerHTML =
        "<tr><td colspan='5'>âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙŠØ¶</td></tr>";
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶
    async function loadReviewHistory(patientId) {
      try {
        const res = await fetch(`/api/medical_report/patient/${patientId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        const data = await res.json();

        const tbody = document.querySelector("#reviewHistoryTable tbody");
        tbody.innerHTML = "";

        if (!data.history || data.history.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>";
          return;
        }

        data.history.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${formatDate(row.review_date)}</td>
            <td>${formatTime(row.review_time)}</td>
            <td><textarea class="doctor-notes" id="doctorNotes-${row.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨">${row.doctor_notes || ''}</textarea></td>
            <td>${row.admission_reason || 'â€”'}</td>
            <td><button onclick="updateNotes('${row.id}')">update Notes</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading review history:", err);
        document.querySelector("#reviewHistoryTable tbody").innerHTML =
          "<tr><td colspan='5'>âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
    async function updateNotes(reviewId) {
      console.log("Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§:", reviewId);

      if (!reviewId) {
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
        return;
      }

      const notes = document.getElementById(`doctorNotes-${reviewId}`).value;

      if (!notes.trim()) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨.');
        return;
      }

      try {
        const response = await fetch(`/api/medical_report/update/${reviewId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({ doctor_notes: notes })
        });

        const data = await response.json();
        if (response.ok) {
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } else {
          alert(`ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${data.error}`);
        }
      } catch (err) {
        console.error('Error updating notes:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
      }
    }
  </script>
</body>
</html>