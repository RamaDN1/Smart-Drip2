const express = require("express");
const cors = require("cors");
const path = require("path");
const dotenv = require('dotenv');
const pool = require("./db");
const bcrypt = require("bcrypt");
const saltRounds = 10;
const jwt = require('jsonwebtoken');
require('dotenv').config({ path: path.join(__dirname, '.env') });

// ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
console.log('JWT Secret Loaded:', process.env.JWT_SECRET ? 'âœ… Yes' : 'âŒ No');

const app = express();

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯ CORS
app.use(cors({
  origin: "http://localhost:3000", // Ø£Ùˆ Ø£ÙŠ Ù†Ø·Ø§Ù‚ ØªØ³ØªØ®Ø¯Ù…Ù‡
  methods: ["GET", "POST"],
  credentials: true
}));

// âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JSON ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
app.use(express.json());

// âœ… Ø¬Ø¹Ù„ Express ÙŠØ®Ø¯Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù„ØªØ´ØºÙŠÙ„ HTML + CSS + JS Ù…Ø¨Ø§Ø´Ø±Ø©)
app.use(express.static(path.join(__dirname, "front")));

// âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
const roomRoutes = require("./routes/rooms");
const patientRoutes = require("./routes/patients");
const entryRoutes = require("./routes/entries");
const valveRoutes = require("./routes/valves");
const userRoutes = require("./routes/users");
const sessionRoutes = require("./routes/sessions");

// âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
app.use("/api/rooms", roomRoutes);
app.use("/api/patients", patientRoutes);
app.use("/api/entries", entryRoutes);
app.use("/api/valve_status", valveRoutes);
app.use("/api/users", userRoutes);
app.use("/api/sessions", sessionRoutes);

// ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
app.post("/api/login", async (req, res) => {
  try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
      if (!req.body?.email || !req.body?.password) {
          return res.status(400).json({ 
              success: false,
              message: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†"
          });
      }

      const { email, password } = req.body;
      console.log("Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", { email });

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const user = await pool.query(
          "SELECT id, name, email, password FROM users WHERE email = $1", 
          [email]
      );

      if (user.rows.length === 0) {
          return res.status(401).json({
              success: false,
              message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"
          });
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      const validPassword = await bcrypt.compare(password, user.rows[0].password);
      if (!validPassword) {
          return res.status(401).json({
              success: false,
              message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"
          });
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ
      if (!process.env.JWT_SECRET) {
        console.error('âŒ Ø®Ø·Ø£ Ø­Ø±Ø¬: JWT_SECRET ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù!');
        console.log('Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙØ­ÙˆØµ:', path.resolve(__dirname, '.env'));
        process.exit(1);
      } else {
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ JWT_SECRET Ø¨Ù†Ø¬Ø§Ø­');
      }
      

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ†
      const token = jwt.sign(
        { 
          user_id: user.rows[0].id,
          email: user.rows[0].email
        },
        process.env.JWT_SECRET, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ØªÙ‡
        { 
          expiresIn: '1h',
          algorithm: 'HS256'
        }
      );

      return res.json({
          success: true,
          token,
          user: {
              id: user.rows[0].id,
              name: user.rows[0].name,
              email: user.rows[0].email
          }
      });

  } catch (err) {
      console.error("ğŸ”¥ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", {
          error: err.message,
          stack: err.stack,
          timestamp: new Date().toISOString()
      });
      
      return res.status(500).json({
          success: false,
          message: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ",
          error: process.env.NODE_ENV === 'development' ? err.message : undefined
      });
  }
});

// ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
app.post("/api/register", async (req, res) => {
  try {
      const { name, email, password } = req.body;
      const hashedPassword = await bcrypt.hash(password, saltRounds); // âœ… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

      const newUser = await pool.query(
          "INSERT INTO users (name, email, password, created_at) VALUES ($1, $2, $3, NOW()) RETURNING id, name, email",
          [name, email, hashedPassword] // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ÙØ±Ø©
      );

      res.status(201).json({
          message: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
          user: newUser.rows[0]
      });
  } catch (err) {
      console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:", err);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±" });
  }

});

// âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø£ÙŠ Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.get("*", (req, res) => {
    res.sendFile(path.join(__dirname, "front", "login.html"));
});

// âœ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
app.use((err, req, res, next) => {
    console.error("âŒ Internal Server Error:", err.message);
    res.status(500).json({ error: err.message });
});

// âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
if (process.env.NODE_ENV !== "test") {
    const PORT = process.env.PORT || 3000;
    app.listen(PORT, () => {
        console.log(`ğŸš€ Server running on port: http://localhost:${PORT}`);
    });
}

module.exports = app;







 const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            }

            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ localStorage
            if (data.token) {
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
            }

            // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            window.location.href = data.redirectTo || '/room.html';

        } catch (error) {
            console.error('Error:', error);
            showAlert('error', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });
});

















 document.querySelector('.sign-in form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
        
        const form = e.target;
        const email = form.email.value;
        const password = form.password.value;

        const submitBtn = form.querySelector('button');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
             
        try {
          
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            }

            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ localStorage
            if (data.token) {
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
            }

            // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            window.location.href = data.redirectTo || '/room.html';

        } catch (error) {
            console.error('Error:', error);
            showAlert('error', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });
});